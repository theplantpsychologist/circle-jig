<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Circle Jig</title>
    <!---<link rel="stylesheet" href="main.css">--->

</head>
<body>
    <h2>Circle Jig</h2>
    <p>Instructions</p>
    <canvas id = "square" width = 500 height = 500>    </canvas>
    <script src="paper-core.js"></script>
    <script src="app2.js"></script>
    <script type="text/javascript" data-paper-ignore = "true">
        paper.setup(document.getElementById("square"));
/*
        point1 = new paper.Point(50,50);
        point2 = new paper.Point(200,450);
        point3 = new paper.Point(450,100);
        path1 = new paper.Path.Arc(point1,point2,point3);
        var riverStyle = {
            strokeColor: "#A8F5FB",
            //strokeJoin: "round"
        }
        path1.style = riverStyle;
        path1.strokeWidth = 20
*/

        circles = []; //the flaps drawn
        lines = []; //the paths drawn
        flaps = []; //an initial empty, once you extract from .tmd5, it will be replaced
        rivers = [];
        paths = []
        function drawBorder(){
            border = new paper.Path.Rectangle(0,0,square.width/1.5,square.height/1.5);
            border.strokeColor = 'black';
            border.strokeWidth = 3;
        }
        drawBorder();
        function calculateRivers(){
            //current problems: 
            //rivers aren't detecting their subrivers bc can't push to surroundedRivers1
            //have to subtract inner path
            //the thing patched up with a try catch
            //what happens when paths in a cluster are not actively connected
            //color scheme


            for(var i=0; i<rivers.length;i++){
                var tempCircles = []
                if (rivers[i].surroundedRivers.length>0){
                    continue;
                    //if the subriver doesn't have it's outer path, wait, and do it on the next iteration
                    
                }
                //surrounded flaps: all the flaps inside a river, including inside subrivers. 
                //the radius of the outer path around the flap will be the distance from inner to the flap + r
            
                for(var j=0; j<rivers[i].surroundedFlaps.length; j++){

                    tempCircles.push(new paper.Path.Circle({
                        center: new paper.Point(
                            rivers[i].surroundedFlaps[j].x *square.width/1.5,
                            rivers[i].surroundedFlaps[j].y *square.width/1.5 *-1 + square.height/1.5),
                        //radius: (rivers[i].surroundedFlaps[j].r + rivers[i].r) *square.width/1.5
                        radius: (findTreeDistance(rivers[i].surroundedFlaps[j],rivers[i].innerNode) + rivers[i].r) *square.width/1.5
                    }))
                }
                rivers[i].outerPath = tempCircles[0];
                for(var j=1; j<tempCircles.length; j++){
                    rivers[i].outerPath = rivers[i].outerPath.unite(tempCircles[j]);
                    tempCircles[j].remove();
                }
                try{
                    rivers[i].outerPath.fillColor = "cyan"
                    rivers[i].outerPath.strokeColor = "black"
                }catch{
                    0
                }
                //==================

            }
        }
        calculateRivers()
        function drawCircles(){
            for (var i=0;i<flaps.length;i++){
                circle = new paper.Path.Circle(new paper.Point(
                    flaps[i].x *square.width/1.5,
                    flaps[i].y *square.width/1.5 *-1 + square.height/1.5
                    ), 
                    flaps[i].r*square.width/1.5);
                circle.strokeColor = "black";
                circle.fillColor = "#C5FBA8"
                circle.strokeWidth = 1;
                circles.push(circle);
            }
        }
        drawCircles(); //should also draw the centers of the circles
        function drawPaths(){
            for (var i=0;i<paths.length;i++){
                paths[i].check(paths[i].node1,paths[i].node2);
                if (paths[i].isActive){
                    path = new paper.Path.Line(
                    new paper.Point(
                            paths[i].node1.x *square.width/1.5,
                            paths[i].node1.y *square.width/1.5 *-1 + square.height/1.5),
                    new paper.Point(
                            paths[i].node2.x *square.width/1.5,
                            paths[i].node2.y *square.width/1.5 *-1 + square.height/1.5));
                    path.strokeColor = 'lime';
                    lines.push(path);
                } else if (paths[i].isInvalid){
                    path = new paper.Path.Line(
                    new paper.Point(
                            paths[i].node1.x *square.width/1.5,
                            paths[i].node1.y *square.width/1.5 *-1 + square.height/1.5),
                    new paper.Point(
                            paths[i].node2.x *square.width/1.5,
                            paths[i].node2.y *square.width/1.5 *-1 + square.height/1.5));
                    path.strokeColor = 'red';
                    lines.push(path);
                }
            }
        }
        drawPaths();
        
        //---------------main---------------
        paper.view.onFrame = function(event){
            /*for (var i=0; i<circles.length;i++){
                circles[i].remove();
            } */
            circles = [];
            lines = []; 
            paper.project.clear();
            calculateRivers();
            drawCircles();
            border.remove()
            drawBorder();
            drawPaths();

        }
        paper.view.draw();

    </script>
    <noscript>Please enable javascript to use this app.</noscript>
    <p>Import your .tmd5 (treemaker) file here:</p>
    <input type="file" id="inputfile" name = "inputfile">
    <pre id="output"></pre>
    <script>
        fileRead();
    </script>
    <button type = button onclick="extract()">Upload</button>  
    <p>This tool was created by Brandon Wong</p>
    <a href="https://github.com/theplantpsychologist/circle-jig"> Github repository</a>  
</body>
</html>